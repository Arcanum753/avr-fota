<!DOCTYPE html>
<html>

<head>
    <title>Esp8266 WiFi &amp Network Configuration.</title>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">    
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <markup>./head.html</markup>
    <h2 class="title" style="background: #7D8EE2">WiFi &amp; network configuration </h2>
    Connect to Router with these settings:<br>
    <table border="1" cellspacing="10" cellpadding="3" align="center">
        <tr><td>
                    <form action="" method="get"> <table border="0" cellspacing="0" cellpadding="3">
                        <tr><td align="right">SSID: </td>        <td><input type="text"  id="p0_ssid" name="ssid" value=""> </td></tr>
                        <tr><td align="right">Password: </td>    <td><input type="password"  id="p0_password" name="password" value=""> </td></tr>
                        <tr><td align="right">DHCP: </td>        <td><input type="checkbox"  id="p0_dhcp" name="dhcp"></td> </tr>
                        <tr><td align="right">IP: </td>
                            <td><input type="text"  id="p0_ip_0" name="ip_0" size="3">.<input type="text"  id="p0_ip_1" name="ip_1" size="3">.<input type="text"  id="p0_ip_2" name="ip_2" size="3">.<input type="text"  id="p0_ip_3" name="ip_3" value="" size="3"></td></tr>
                        <tr><td align="right">Netmask:</td>
                            <td><input type="text"  id="p0_nm_0" name="nm_0" size="3">.<input type="text"  id="p0_nm_1" name="nm_1" size="3">.<input type="text"  id="p0_nm_2" name="nm_2" size="3">.<input type="text"  id="p0_nm_3" name="nm_3" size="3"></td></tr>
                        <tr><td align="right">Gateway:</td>
                            <td><input type="text"  id="p0_gw_0" name="gw_0" size="3">.<input type="text"  id="p0_gw_1" name="gw_1" size="3">.<input type="text"  id="p0_gw_2" name="gw_2" size="3">.<input type="text"  id="p0_gw_3" name="gw_3" size="3"></td></tr>
                        <tr><td align="right">DNS:</td>
                            <td><input type="text"  id="p0_dns_0" name="dns_0" size="3">.<input type="text"  id="p0_dns_1" name="dns_1" size="3">.<input type="text"  id="p0_dns_2" name="dns_2" size="3">.<input type="text"  id="p0_dns_3" name="dns_3" size="3"></td> </tr>
                            <input type="hidden" name="wificonf" value="0" />
                        <tr><td colspan="2" align="center"><input type="submit" value="Save"></td></tr>
                    </table></form>
        </td><td>
                <form action="" method="get"><table border="0" cellspacing="0" cellpadding="3">
                        <tr><td align="right">SSID: </td>        <td><input type="text"  id="p1_ssid" name="ssid" value=""> </td></tr>
                        <tr><td align="right">Password: </td>    <td><input type="password"  id="p1_password" name="password" value=""> </td></tr>
                        <tr><td align="right">DHCP: </td>        <td><input type="checkbox"  id="p1_dhcp" name="dhcp"></td> </tr>
                        <tr><td align="right">IP: </td>
                            <td><input type="text"  id="p1_ip_0" name="ip_0" size="3">.<input type="text"  id="p1_ip_1" name="ip_1" size="3">.<input type="text"  id="p1_ip_2" name="ip_2" size="3">.<input type="text"  id="p1_ip_3" name="ip_3" value="" size="3"></td></tr>
                        <tr><td align="right">Netmask:</td>
                            <td><input type="text"  id="p1_nm_0" name="nm_0" size="3">.<input type="text"  id="p1_nm_1" name="nm_1" size="3">.<input type="text"  id="p1_nm_2" name="nm_2" size="3">.<input type="text"  id="p1_nm_3" name="nm_3" size="3"></td></tr>
                        <tr><td align="right">Gateway:</td>
                            <td><input type="text"  id="p1_gw_0" name="gw_0" size="3">.<input type="text"  id="p1_gw_1" name="gw_1" size="3">.<input type="text"  id="p1_gw_2" name="gw_2" size="3">.<input type="text"  id="p1_gw_3" name="gw_3" size="3"></td></tr>
                        <tr><td align="right">DNS:</td>
                            <td><input type="text"  id="p1_dns_0" name="dns_0" size="3">.<input type="text"  id="p1_dns_1" name="dns_1" size="3">.<input type="text"  id="p1_dns_2" name="dns_2" size="3">.<input type="text"  id="p1_dns_3" name="dns_3" size="3"></td> </tr>
                            <input type="hidden"  name="wificonf" value="1" />
                            <tr><td colspan="2" align="center"><input type="submit" value="Save"></td></tr>
                        
                </table></form>
            </td></tr>
            <tr><td>
                <form action="" method="get">   <table border="0" cellspacing="0" cellpadding="3">
                    <tr><td align="right">SSID: </td>        <td><input type="text"  id="p2_ssid" name="ssid" value=""> </td></tr>
                    <tr><td align="right">Password: </td>    <td><input type="password"  id="p2_password" name="password" value=""> </td></tr>
                    <tr><td align="right">DHCP: </td>        <td><input type="checkbox"  id="p2_dhcp" name="dhcp"></td> </tr>
                    <tr><td align="right">IP: </td>
                        <td><input type="text"  id="p2_ip_0" name="ip_0" size="3">.<input type="text"  id="p2_ip_1" name="ip_1" size="3">.<input type="text"  id="p2_ip_2" name="ip_2" size="3">.<input type="text"  id="p2_ip_3" name="ip_3" value="" size="3"></td></tr>
                    <tr><td align="right">Netmask:</td>
                        <td><input type="text"  id="p2_nm_0" name="nm_0" size="3">.<input type="text"  id="p2_nm_1" name="nm_1" size="3">.<input type="text"  id="p2_nm_2" name="nm_2" size="3">.<input type="text"  id="p2_nm_3" name="nm_3" size="3"></td></tr>
                    <tr><td align="right">Gateway:</td>
                        <td><input type="text"  id="p2_gw_0" name="gw_0" size="3">.<input type="text"  id="p2_gw_1" name="gw_1" size="3">.<input type="text"  id="p2_gw_2" name="gw_2" size="3">.<input type="text"  id="p2_gw_3" name="gw_3" size="3"></td></tr>
                    <tr><td align="right">DNS:</td>
                        <td><input type="text"  id="p2_dns_0" name="dns_0" size="3">.<input type="text"  id="p2_dns_1" name="dns_1" size="3">.<input type="text"  id="p2_dns_2" name="dns_2" size="3">.<input type="text"  id="p2_dns_3" name="dns_3" size="3"></td> </tr>
                        <input type="hidden" name="wificonf" value="2" />
                    <tr><td colspan="2" align="center"><input type="submit" value="Save"></td></tr>
                </table> </form>
            </td><td>
                <form action="" method="get">   <table border="0" cellspacing="0" cellpadding="3">
                        <tr><td align="right">SSID: </td>        <td><input type="text"  id="p3_ssid" name="ssid" value=""> </td></tr>
                        <tr><td align="right">Password: </td>    <td><input type="password"  id="p3_password" name="password" value=""> </td></tr>
                        <tr><td align="right">DHCP: </td>        <td><input type="checkbox"  id="p3_dhcp" name="dhcp"></td> </tr>
                        <tr><td align="right">IP: </td>
                            <td><input type="text"  id="p3_ip_0" name="ip_0" size="3">.<input type="text"  id="p3_ip_1" name="ip_1" size="3">.<input type="text"  id="p3_ip_2" name="ip_2" size="3">.<input type="text"  id="p3_ip_3" name="ip_3" value="" size="3"></td></tr>
                        <tr><td align="right">Netmask:</td>
                            <td><input type="text"  id="p3_nm_0" name="nm_0" size="3">.<input type="text"  id="p3_nm_1" name="nm_1" size="3">.<input type="text"  id="p3_nm_2" name="nm_2" size="3">.<input type="text"  id="p3_nm_3" name="nm_3" size="3"></td></tr>
                        <tr><td align="right">Gateway:</td>
                            <td><input type="text"  id="p3_gw_0" name="gw_0" size="3">.<input type="text"  id="p3_gw_1" name="gw_1" size="3">.<input type="text"  id="p3_gw_2" name="gw_2" size="3">.<input type="text"  id="p3_gw_3" name="gw_3" size="3"></td></tr>
                        <tr><td align="right">DNS:</td>
                            <td><input type="text"  id="p3_dns_0" name="dns_0" size="3">.<input type="text"  id="p3_dns_1" name="dns_1" size="3">.<input type="text"  id="p3_dns_2" name="dns_2" size="3">.<input type="text"  id="p3_dns_3" name="dns_3" size="3"></td> </tr>
                            <input type="hidden" name="wificonf" value="3" />
                        <tr><td colspan="2" align="center"><input type="submit" value="Save"></td></tr>
                    </table> </form>
            </td></tr>
        </table>
    <hr>
    <table><tr><td><strong>Connection State:</strong></td>	<td><div id="connectionstate">N/A</div>	</td></tr></table>
    <hr>
    <strong>WiFi networks scanned arround: </strong><span id="numNets"></span>
    <br>
    <table border="0" cellspacing="3" align="center">
        <tr>
            <td>
                <table>
                    <thead bgcolor='#DDDDDD'>
                        <tr>
                            <th style="width:200px">SSID</th>
                            <th>Channel</th>
                            <th style="width:80px">Secure</th>
                            <th>RSSI</th>
                        </tr>
                    </thead>
                    <tbody id="networks"></tbody>
                </table>
            </td>
        </tr>
        <tr>
            <td align="center">
                <a href="javascript: getNetwork();" >Refresh</a>
            </td>
        </tr>
    </table>

    <markup>./bottom.html</markup>
	<script src="GetJson.js" defer></script>
	<script src="GetMarkup.js" defer></script>
	<script>
		window.onload = function() {
            getNetwork();

			ApplyCVT("/admin/connectionstate")
                .then(() => ApplyCVT("/admin/infovalues"))
                .then(() => ApplyCVT("/admin/values/0", "p0_"))
                .then(() => ApplyCVT("/admin/values/1", "p1_"))
                .then(() => ApplyCVT("/admin/values/2", "p2_"))
                .then(() => ApplyCVT("/admin/values/3", "p3_"))

            setTimeout(() => {
                ApplyCVT("/admin/devconf");
			}, 1000);
		};
	</script>

<script language="javascript" type="text/javascript">
    function securityStr(security) {
        if (security == 7) {
            return 'Open';
        } else if (security == 5) {
            return 'WEP';
        } else if (security == 2) {
            return 'WPA';
        } else if (security == 4) {
            return 'WPA2';
        } else if (security == 8) {
            return 'WPA/WPA2';
        }
    }

    function wifiScan(res) {
        var array;

        if (!res || (res.target.responseText == '[]')) {
            setTimeout(function() {
                getNetwork();
            }, 5000);
            return;
        }
        array = JSON.parse(res.target.responseText);
        array.sort(function(a, b) {
            return a.rssi - b.rssi
        });
        array.reverse();
        document.getElementById("numNets").innerHTML = array.length;
        var table = document.getElementById("networks");
        table.innerHTML = "";
        for (var i = 0; i < array.length; i++) {
            var row = document.createElement("tr");
            row.innerHTML = "<td><a href='javascript:selssid(\"" + array[i].ssid + "\")'>" + array[i].ssid + "</td><td>" + array[i].channel + "</td><td>" + securityStr(array[i].secure) + "</td><td>" + array[i].rssi + "</td>";
            table.appendChild(row);
        }
    }

    function getNetwork() {
        request = new XMLHttpRequest();
        if (request) {
            request.open("GET", "/scan", true);
            request.addEventListener("load", wifiScan)
            request.send();
        }
    }

    function selssid(value) {
        document.getElementById("ssid").value = value;
    }


</script>
</body>

</html>
