# avr-fota
Программатор AVR чипов по Wi-Fi.

## Список базового функционала.
1. Wi-Fi клиент/точка доступа;
1. Возожность работы с одной из четырёх Wi-Fi точек доступа (далее — ТД) с индивидуальным хранением сетевых настроек каждой ТД (DHCP/ статичный IP);
1. Веб-сервер. Веб-страницы;
1. Файловая система (далее ФС);
1. NTP клиент. Возможность переключение на другой NTP сервер в случае невозможности подключения на основной (один основной + два резервных);
1. Самообновление прошивки (FOTA) ESP8266 микроконтроллера через веб-интерфейс;
1. Браузер файловой системы и редактор .html .txt .json .js файлов;
1. Защита от неавторизованных пользователей с использованием логина и пароля;
1. Программно реализованый программатор AVR-ISP на основе прошивки https://github.com/adafruit/Standalone-Arduino-AVR-ISP-programmer/
1. Загрузка и проверка .hex файлов. Прошивка .hex файлами AVR чипа;
1. Хранение двух версий прошивок (актуальной и предыдущей) в ФС для возможноси отката на предыдущую версию в случаей неудачной актуальной версии.

#### Используемые сокращения
> **ФС** Файловаая система
> 
> **ТД** Точка доступа
> 


## Назначение проекта.
Проект-заготовка с минимальным базовым функционалом для VSCode + Platformio. Основа для будущих проектов. 

## Назначение прошивки.
Прошивка для микроконтроллера **ESP8266 на плате Wemos D1 Mini** предназначенная для прошивки микроконтроллеров семейств **AVR** AtMega/AtTiny через веб-интерфейс по локальной сети.

## Основа прошивки.
За основу взята прошивка https://github.com/gmag11/FSBrowserNG и по сути данный репозиторий является глубоко модифицированным форком.

Также использовался https://github.com/adafruit/Standalone-Arduino-AVR-ISP-programmer/ из которого взяты некоторые фрагменты кода по работе протокола ISP программатора.

## Требование проекта и прошивки.
Предполагается что скачавший данный репозиторий пользователь умеет работать в редакторе кода **VSCode** и с плагином **PlatformIO**.

Данный проект создавался в **VSCode** (версии 1.89.1) с установленным плагином **PlatformIO** (версии 3.3.3).

Для работы прошивки требуется микроконтроллер **ESP8266 на плате Wemos D1 Mini**.

Для создания .hex файлов для AVR чипов требуется **Atmel Stuido** или **Microchip Stuido** версий не старше 2023 года.

# ESP8266

## Первое знакомство с проектом и включение ESP8266 (коротко).
1. Ознакомиться с данным описанием репозитория;
1. Скачать и установить **VSCode** и плагин **PlatformIO**;
1. Склонировать репозиторий;
1. Скомпилировать проект;
1. Сформировать образ ФС;
1. Загрузить образ ФС через UART;
1. Прошить ESP8266 через UART.

## Скачивание, установка, настройка проекта.
Установка проекта происходит путём клонирования данного репозитория на локальный ПК в директорию в пути которой прописаны только латинские символы, без пробелов.

## Зависимые библиотеки проекта.
Все критически важные библиотеки уже входят в состав данного репозитория. В случае если какие-то библиотеки отсутствуют, то плагин PlatformIO скачает и установит их самостоятельно.

## Структура директорий проекта.
Директория **data** — содержит все веб-страницы и файлы веб-сервера. Из этой директории подготавливается файл-образ ФС;

Директория **bat** — содержит .bat файл добавляющий метаинформацию в .hex файл. Необходимый для проекта в Atmel Stuido;

Директория **src** — содержит файлы исходного кода;

Директория **include** — содержит заголовочные файлы;

Директория **.pio**	— содержит файлы плагина PlatformIO, но самое главное содержит в себе файл **firmware.bin** (путь до файла \.pio\build\d1_mini_pro\firmware.bin ) котрый требуется для OTA прошивки чипа ESP8266;

Директория **MS project example** — содержит пример проекта для Atmel/Microchip Studio.

## Файлы настроек.
Содержатся в директории **data** проекта. В ФС ESP8266 расположены в корневой директории.

Файл **config_general.json** — содержит основные настройки устройства (имя устройства и серийный номер), а также настройки NTP клиента.

Файл **avrisp.json** — содержит настройки для работы AVR программатора и инфорамацию о текущей и предыдущих версиях .hex файлов.

Файлы **config_wifi0.json config_wifi1.json config_wifi2.json config_wifi3.json** — настройки для работы с несколькими точками доступа.

Файл **secret.json** — содержит в себе логин и пароль для веб-авторизации на веб-сервере ESP8266. Этот же пароль является паролем для ESP8266 если оный работает в роли точки доступа. Не отображается в браузере ФС.

## Компиляция и отладка прошивки для ESP8266.
Для компиляции проекта тредуется нажать на кнопку плагина ("инопланетянин" слева) и выбрать опцию **build**.

Для для отладки доступен **Monitor** и встроенный в VSCode терминал. Настройки монитора прописываются в файле platformio.ini.

## Загрузка прошивки (UART/OTA) на ESP8266.
### UART.
Панель плагина platformio.

Прошивка чипа ESP8266 через встроенный usb/uart преобразователь доступна по кнопке **upload**.

Кнопка **upload and monitor** запускает монитор сразу после окончания прошивки ESP8266.

### OTA.
В данной прошивке ESP8266 реализована возможность самостоятельной перепрошивки без использования USB/UART преобразователя.

Если ESP8266 работает в режиме ТОЧКИ ДОСТУПА, то надо подключиться со смартфорна или ПК и через веб-браузер зайти на страницу http://192.168.4.1/update.html ;

Если ESP8266 работает в режиме КЛИЕНТА точки доступа Wi-Fi, то веб-страницы ESP8266 доступны по адресам:

- (по умолчанию) http://esp8266_a001.local/update.html, где **esp8266_a001** это имя и серийный номер устройства;

- или http://192.168.43.65/update.html, где IP выдаётся точкой доступа. Узнать IP ESP8266 можно зайдя на свою точку доступа.

Затем на странице требуется указать путь до файла и, если MD5 хеш сумма файла посчитана верно и файл не испорчен, разблокируется кнопка **Update es8266 firmware** и начнётся самообновление прошивки ESP8266, после чего ESP8266 перезапустится.

## Загрузка образа файловой системы на ESP8266.
Панель плагина platformio.

**Build Filesystem Image** — сборка образа ФС на основе директории data;

**Upload Filesystem Image** — загрузка фала образа ФС по UART.

> [!WARNING]
> **ВНИМАНИЕ! После любой манипуляции с UART микроконтроллера ESP8266 происходит перезапуск микроконтроллера!**

## Первое включение ESP8266.
Если не были прописаны настройки ТД Wi-Fi в .json файлы, то через минуту после включения ESP8266 сама перейдёт в режим ТД, и в списке Wi-Fi сетей появится ТД c именем ESP8266_A001 (имя по умолчанию) и без пароля. Подключившись с этой ТД можно зайти на главную страницу ESP8266 по адресу http://192.168.4.1/ или http://esp8266_a001.local (функция **MDNS** или имя в локальной сети. Может не работать, функция экспериментальная!).

## Резервирование точек доступа.
ESP8266 при включении сканирует эфир в течение минуты и если в эфире присутсвует одна из прописанных ТД, то идёт подключение к ней. Таких ТД может быть настроено до четырёх и при этом можно для каждой индивидуально прописать настройки dhcp/статический IP адрес.

## Веб-авторизация.
Для предотвращения несанкционированного доступа предусмотрена авторизация по логину и паролю. Пароль запрашивается при первом обращении к любой странице ESP8266. Этот же пароль служит для доступа к ESP8266 в режиме ТД.

## Список доступных страниц и их назначение.
Сверху каждой страницы есть ссылки на другие страницы с функционалом.
1. Main. Показывает текущую информацию о данном экземпляре ESP8266 и основные настройки;
1. Device configuration. Редактирование имени устройства и серийного номера. ИмяУстройства_СерийныйНомер дают имя для ESP8266 в режиме ТД и имя для MDNS. Также позволяет редактировать сигнатуру AVR чипа, имя проекта Atmel/Microchip Studio, объём AVR памяти чипа;
1. NTP Settings. Настройка адресов NTP серверов, времени опроса, часового пояса, летнего/зимнего времени. Можно настроить три сервера. Если сервер недоступен, то идёт переключение на другой;
1. AVR fOTA. Страница прошивки AVR чипа. Содержит информацию о текущей версии прошивки и предыдущей версии прошивки, а также времени последнего обновления прошивки (не путать со временем сборки);
1. ESP8266 Network Configuration. Редактирование настроек ТД к которым может подключиться ESP8266;
1. ESP8266 Network Information. Отображение информации о текущем сетевом подключении;
1. ESP8266 System Setting. Содержит кнопку "Restart" которая перезагружает ESP8266. Позволяет редактировать логин и пароль для веб-авторизации;
1. ESP8266 FS Browser. Браузер ФС и редактор файлов. Работает если ESP8266 имеет доступ в Интернет;
1. ESP8266 FOTA. Страница самопрошивки ESP8266.

# AVR
Для разработки прошивки AVR чипа требуются IDE **Atmel Studio** или **Microchip Studio**.

Для прошивки AVR микроконтроллера требуется сам микроконтроллер или плата Arduino с выведенной группой контактов для подключения ISP программатора. 

Также требуется знать идентификатор чипа и его максимальный размер памяти программ. Прописать сигнатуру чипа можно на странице http://ESP8266_a001.local/general.html в формате 0x1E940B (для примера). Использовать только английскую раскладку.

На данный момент проект протестирован на двух чипах:
1. Atmega168P  сигнатура 0x1E940B;
1. Atmega328P  сигнатура 0x1E950F.

Размер памяти программ и сигнатуру можно узнать из даташитов к указанным чипам.

## Подключение AVR чипа. Распиновка.

> [!WARNING]
> **ВНИМАНИЕ! ESP8266 И AVR ЧИПЫ ДОЛЖНЫ БЫТЬ СОГЛАСОВАНЫ ПО УРОВНЮ НАПРЯЖЕНИЯ ПИТАНИЯ ИЛИ ДОЛЖЕН ИСПОЛЬЗОВАТЬСЯ СОГЛАСОВАТЕЛЬ НАПРЯЖЕНИЙ СИГНАЛЬНЫХ ЛИНИЙ!**

 ESP8266 | AVR (Atmega328p) 
:---------|------------------:
 G12     | MISO (D6)        
 G13     | MOSI (D7         
 G14     | SCK (D5)         
 G5      | RST (D1)         
 GND     | GND              
 +3.3V   | +3.3V            

Распиновка приведена на примене чипа Atmega328p. Любой другой AVR чип подключается аналогично на интерфейс **SPI**.

## Метаданные.
В начало каждого .hex файла Atmel/Microchip Studio проекта есть возможность добавлять метаданные.

Мета содержит в себе такую информацию как:
1. Название проекта; 
1. Сигнатура целевого чипа AVR;
1. Версия прошивки. Версия прописывается вручную в файле ver.h проекта и эта информация автоматически добавляется в мету;
1. Время сборки;
Данная метаинформация затем проверяется автоматически на ESP8266. В случае если название проекта и сигнатура чипа не совпадают с названием проекта и сигнатурой чипа настроенными на странице Device configuration, то данный .hex файл не будет допущен к прошивке в AVR чип.

### Подготовка проекта Atmel/Microchip Studio.
1. Создать или открыть существующий проект;
1. Написать требуемый вам код;
1. Обязательно добавить файл **ver.h** из папки **bat** репозитория в сам проект и папку проекта;
1. В свойствах проекта, вкладка Tool настройка Selected debugger/Simulator выбрать **Simulator**;
1. Скомпилировать проект;
1. Скачать .bat файл в папку Debug (или Release) проекта Atmel/Microchip Studio;
1. В свойствах проекта, в окне редактора макросов **Post-build event command line:** добавить строку
* postbuild_top.bat "$(OutputDirectory)" "$(OutputFileName)" "$(avrdeviceexpectedsignature)" "$(AssemblyName)"  "$(MSBuildProjectDirectory)\ver.h" *
из **файла for atmel studio post build.txt** ;
1. Скомпилировать проект;
При этом в папке Debug (или Release) создаётся .hex файл содержащий цифры версии из файла ver.h. В случае если версия не менялась, то при новой компиляции .hex файл пересоздаётся.

## Загрузка и прошивка .hex файла.
Полученный .hex файл можно отправить на ESP8266. Для этого надо открыть веб-страницу **AVR fOTA**, нажать "Обзор", указать файл и затем нажать "Upload .hex file".
После чего будет произведена загрузка файла. По окончании загрузки будет произведена проверка загруженного файла на метаданные и проверка целостности бинарных файлов. Если метаданные совпадают с настройками прописанными в ESP8266, то разблокируется кнопка "Update Firmware".

По нажатию на кнопку "Update Firmware" производится прошивка AVR чипа.

После прошивки чипа происходит верификация записанных данных.

Также сохраняется время последнего обновления прошивки чипа (не путать со временем сборки).

## Игнорирование проверки метаданных.
Предусмотрена возможность загрузки .hex файлов без метаданных. Для этого нужно загрузить .hex файл и нажать на чекбокс "Ignore meta checking", после чего разблокируется кнопка "Update Firmware".

> [!WARNING]
> **ПРЕДУПРЕЖДЕНИЕ! ДАННАЯ ФУНКЦИЯ ИСПОЛЬЗУЕТСЯ ПОЛЬЗОВАТЕЛЕМ НА СВОЙ СТРАХ И РИСК!**

## Откат прошивки.
В ФС ESP8266 постоянно хранится две версии .hex файла — текущая и предыдущая версии. В случае если новая версия не удовлетворяет каким-либо требованиям, то по нажатию кнопки 'Rollback version" происходит прошивка AVR чипа .hex файлом предыдущей версии. При этом новая версия файла удаляется из ФС.


## Условия пользования и отказ от ответственности 
Проект распространяется в виде **"как есть"** aka **"as-is"** — копируя/клонируя или изменяя части данного проекта, включая исходные коды, скрипты, документацию, принципиальные и/или блочные схемы, чертежи, вы соглашаетесь с тем, что автор проекта НЕ несёт ответственность за ваши действия в любом случае. 

Если вы нашли проблему, пожалуйста, уточните и перепроверьте её формулировку, а затем пришлите issue или оформите pull request в Github.

Добро пожаловать в ТГ чат https://t.me/Skermajenie_chat — здесь мы вместе сможем обсудить что-то по мере возможности.

Также следить за ходом разработки можно в личном ТГ-блоге автора https://t.me/Skermajenie

В качестве благодарности за то, что автор данного проекта дал вам идею/концепцию/проект/код — можете писать имя автора в описании к вашему продукту/проекту, это ни к чему не обязывает финансово и юридически, но автору будет приятно. 

**Автор: Самуил Германович Арканум.**
